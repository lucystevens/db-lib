![Develop Status][workflow-badge-develop]
![Main Status][workflow-badge-main]
![Version][version-badge] 

# db-lib
**db-lib** is a library for managing database connections and ORM using [Hibernate][hibernate-site]

## Installation

Install the latest version of db-lib using Maven:

```	
<dependency>
	<groupId>uk.co.lukestevens</groupId>
	<artifactId>db-lib</artifactId>
	<version>2.0.0</version>
</dependency>
```

and the latest version of [base-lib][base-lib-repo]

### Github Packages Authentication
Currently public packages on Github require authentication to be installed by Maven. Add the following repository to your project's `.m2/settings.xml`

```
<repository>
	<id>github-lukecmstevens</id>
	<name>GitHub lukecmstevens Apache Maven Packages</name>
	<url>https://maven.pkg.github.com/lukecmstevens/packages</url>
	<snapshots><enabled>true</enabled></snapshots>
</repository>
```

For more information see here: [Authenticating with Github packages][gh-package-auth]

## Usage
db-lib provides classes for both querying databases directly, and using hibernate

### Direct access
#### Creating a Database
To create a new Database from the following config values
- database.url
- database.username
- database.password

```
Database database = new ConfiguredDatabase(config);
```

Or create a database defining those values in the constructor:

```
Database database = new SimpleDatabase(url, username, password);
```

#### Querying the Database
Database queries return a closeable `DatabaseResult` containing ease of use methods for iterating over the result set:

```
try(DatabaseResult result = database.query(sql, params)) {
	result.processResultSet(rs -> System.out.println("Do something for every result"));
	// OR
	List<String> results = result.parseResultSet(rs -> "Parse the result into another object"));
}
```

#### Updating the Database
Database update queries return an `Optional<Long` representing the generated id from the query, if one exists:

```
// Id generated by insert
Optional<Long> id = database.update("insert into foo values(?)", bar);

// Id not present on row update
Optional<Long> empty = database.update("update foo where value=?", bar);
```


### Hibernate
For more complex objects, db-lib also supports the use of Hibernate ORM.
This uses the same config as directly accessing the database, as well as any Hibernate specific config found.

#### Setting up Hibernate
To use Hibernate, first set up the `HibernateController`. This loads any entities annotated with `@Entity` from your application group packages.

```
DaoProvider hibernate = new HibernateController(config, applicationProperties);
```

You can then use this controller to create Daos for any Hibernate managed entities:

```
Dao<Foo> fooDao = hibernate.getDao(Foo.class);
```

#### Using Hibernate Daos
These `Dao` classes can then be used for standard CRUD operations using the models, and filters applied using `QueryFilters`.

```
// Get
Foo foo = fooDao.get(filter);

// List all
List<Foo> allFoo = fooDao.list();
	
// List with filter
List<Foo> filteredFoo = fooDao.list(filter);
	
// Save or update
fooDao.save(foo);
	
// delete
fooDao.delete(foo);
```

#### Applying QueryFilters
QueryFilters are an easy way to build Hibernate compatible query clauses using bound parameterised statements:


**Creating a simple filter**

```
// name='test'
QueryFilters.column("name").isEqualTo("test");
```

**Using AND and OR clauses**

```
// name='test' AND value>12
QueryFilters.and(
	QueryFilters.column("name").isEqualTo("test"),
	QueryFilters.column("value").isGreaterThan(12)
);

// country IN ('UK', 'US', 'DE') OR key IS NOT NULL OR count>=4
QueryFilters.or(	
		QueryFilters.column("country").isIn("UK", "US", "DE");
		QueryFilters.column("key").isNotNull();
		QueryFilters.column("count").isLessThanOrEqualTo(4);
);
```

**Combining filters**

```
// (country='UK' AND count>500) OR (country='US' AND count>750)
QueryFilters.or(
	QueryFilters.and(
		QueryFilters.column("country").isEqualTo("UK")
		QueryFilters.column("count").isGreaterThan(500)
	),
	QueryFilters.and(
		QueryFilters.column("country").isEqualTo("US")
		QueryFilters.column("count").isGreaterThan(750)
	)
);
```

## Contributing
Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.

New features, fixes, and bugs should be branched off of develop.

Please make sure to update tests as appropriate.

## License
[MIT][mit-license]

[base-lib-repo]: https://github.com/lukecmstevens/base-lib
[gh-package-auth]: https://docs.github.com/en/free-pro-team@latest/packages/guides/configuring-apache-maven-for-use-with-github-packages#authenticating-to-github-packages
[workflow-badge-develop]: https://img.shields.io/github/workflow/status/lukecmstevens/db-lib/publish/develop?label=develop
[workflow-badge-main]: https://img.shields.io/github/workflow/status/lukecmstevens/db-lib/release/main?label=main
[version-badge]: https://img.shields.io/github/v/release/lukecmstevens/db-lib
[mit-license]: https://choosealicense.com/licenses/mit/
[hibernate-site]: http://hibernate.org/orm/